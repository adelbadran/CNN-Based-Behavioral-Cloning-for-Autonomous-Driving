<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Driving Car Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap'); /* خط مستقبلي */

         :root {
            --primary-color: #6432c8;
            --primary-light: #8b5fbf;
            --primary-dark: #4a237a;
            --accent-green: #00ff88;
            --accent-pink: #ff6b9d;
            --accent-cyan: #00d4ff;
            --accent-orange: #ff8c42;
            --bg-dark: #0a0e27;
            --bg-secondary: #1a1f3a;
            --bg-tertiary: #252d4a;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --border-color: rgba(100, 50, 200, 0.3);
            --success: #00ff88;
            --warning: #ff8c42;
            --danger: #ff6b9d;
        }


        body {
            font-family: 'Orbitron', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d0015 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            text-align: center;
            color: var(--text-primary);
        }
        
        #simulation-container {
            position: relative;
            width: 700px;
            height: 400px;
            margin: 30px 20px;
            background-color: rgba(26, 31, 58, 0.6);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #simulation-container:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
        }

        #road-view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            overflow: hidden;
        }

        #road-frame {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #car-interior {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: 550px;
            background-image: url('assets/car_interior_mask.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 15;
            pointer-events: none;
            box-shadow: inset 0 0 60px rgba(0, 0, 0, 0, 0.8);
        }

        #steering-wheel-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 650px;
            height: 450px;
            z-index: 20;
        }

        #controls {
            margin-top: 30px;
            padding: 30px 130px;
            background: linear-gradient(135deg, rgba(100, 50, 200, 0.15), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 
                0 0 25px rgba(0, 212, 255, 0.15),
                inset 0 0 12px rgba(100, 50, 200, 0.2);
            display: flex;
            gap: 50px;
            align-items: center;
            backdrop-filter: blur(8px);
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        #controls:hover{
            border-color: var(--primary-dark);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
            transform: translateY(-5px);
        }
        
        #controls h3 {
            background: linear-gradient(135deg, var(--accent-cyan), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 0;
            font-weight: 700;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.4);
            margin-bottom: 20px;
        }

        #start-button {
            padding: 12px 28px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            background: linear-gradient(145deg, var(--primary-color), var(--primary-light));
            color: white;
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 10px rgba(100, 50, 200, 0.4),
                0 8px 20px rgba(139, 95, 191, 0.3);
            letter-spacing: 0.8px;
        }

        #start-button:hover {
            background: linear-gradient(145deg, var(--primary-light), #a06cd5);
            transform: translateY(-3px);
            box-shadow: 
                0 8px 20px rgba(100, 50, 200, 0.5),
                0 12px 30px rgba(139, 95, 191, 0.4);
        }

        #start-button:active {
            transform: translateY(2px);
            box-shadow: 0 4px 10px rgba(100, 50, 200, 0.3);
        }
        
        #angle-display {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: var(--accent-orange);
            font-size: 1.6em;
            padding: 8px 16px;
            border: 1px solid var(--accent-orange + '44');
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            display: inline-block;
            min-width: 120px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 140, 66, 0.6);
            box-shadow: 0 0 15px rgba(255, 140, 66, 0.2);
        }
        
        #controls p {
            margin: 5px 5px 0 5px;
            font-size: 0.9em;
            color: #a0a0a0;
        }

        /* Integrated Dashboard Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0d0015 100%);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: rgba(26, 31, 58, 0.95);
            border-bottom: 2px solid var(--border-color);
            padding: 30px 120px;
            display: flex;
            border-radius: 15px;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            margin-top: 50px;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-cyan), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-right: 30px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(100, 50, 200, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--success);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .container {
            width: 1200px;
            margin: 0 auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            padding-bottom: 15px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--accent-cyan);
        }

        .nav-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(100, 50, 200, 0.15), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-unit {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-change {
            font-size: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            color: var(--success);
        }

        /* Chart Container */
        .chart-container {
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.8), rgba(37, 45, 74, 0.5));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-icon {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-cyan);
        }

        .chart-area {
            width: 100%;
            height: 400px;
            position: relative;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        /* Color Theme Customizer */
        .theme-customizer {
            background: linear-gradient(135deg, rgba(100, 50, 200, 0.15), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .color-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .color-input {
            width: 100%;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-tertiary);
        }

        /* Button */
        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(100, 50, 200, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            margin-top: 40px;
            font-size: 12px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 16px;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .chart-area {
                height: 300px;
            }
        }

    </style>
</head>
<body>
<div id="simulation-container">
       
        <div id="road-view">
            <img id="road-frame" src="" alt="Road Frame">
        </div>
        <div id="car-interior">
            </div>
        <div id="steering-wheel-container">
            </div>
    </div>
    <div id="controls">
        <button id="start-button">Play Auto mode</button>
        <div>
            <h3>Result Of Prediction</h3>
            <p><span id="angle-display">0.000</span></p>
        </div>
    </div>
    <!-- Integrated Dashboard -->
    <!-- Header -->
    <div class="header">
        <div class="header-title">Autonomous Driving Dashboard</div>
        <div class="header-controls">
            <div class="api-status">
                <div class="status-indicator" id="apiStatus"></div>
                <span id="apiStatusText">Connecting...</span>
            </div>
        </div>
    </div>
    <!-- Main Container -->
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('steering')">Steering Angle</button>
            <button class="nav-tab" onclick="switchTab('speed')">Speed & Acceleration</button>
            <button class="nav-tab" onclick="switchTab('analysis')">Advanced Analysis</button>
            <button class="nav-tab" onclick="switchTab('events')">Events</button>
            <button class="nav-tab" onclick="switchTab('settings')">Settings</button>
        </div>
        <!-- TAB 1: Overview -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Predictions</div>
                    <div class="stat-value" id="totalPredictions">0</div>
                    <div class="stat-unit">frames</div>
                    <div class="stat-change">Live update</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Angle</div>
                    <div class="stat-value" id="avgAngle">0</div>
                    <div class="stat-unit">degrees</div>
                    <div class="stat-change">Last session</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max Angle</div>
                    <div class="stat-value" id="maxAngle">0</div>
                    <div class="stat-unit">degrees</div>
                    <div class="stat-change">Extreme value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Number of Turns</div>
                    <div class="stat-value" id="turnCount">0</div>
                    <div class="stat-unit">turns</div>
                    <div class="stat-change">Sharp turns > 15°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Model Stability</div>
                    <div class="stat-value" id="stability">0</div>
                    <div class="stat-unit">%</div>
                    <div class="stat-change">Lower fluctuation = better</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">API Status</div>
                    <div class="stat-value" id="apiHealth">Ready</div>
                    <div class="stat-unit">Connected</div>
                    <div class="stat-change">Ready for use</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    Performance Summary
                </div>
                <div class="chart-area" id="overviewChart"></div>
            </div>
        </div>
        <!-- TAB 2: Steering Angle Timeline -->
        <div id="steering" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    Steering Angle Over Time (with sharp turn shading)
                </div>
                <div class="chart-area" id="steeringChart"></div>
            </div>
        </div>
        <!-- TAB 3: Speed & Acceleration -->
        <div id="speed" class="tab-content">
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon"></div>
                        Speed Over Time
                    </div>
                    <div class="chart-area" id="speedChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon"></div>
                        Acceleration / Deceleration
                    </div>
                    <div class="chart-area" id="accelerationChart"></div>
                </div>
            </div>
        </div>
        <!-- TAB 4: Advanced Analysis -->
        <div id="analysis" class="tab-content">
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon"></div>
                        Steering Angle Distribution
                    </div>
                    <div class="chart-area" id="histogramChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon"></div>
                        Heatmap: Speed vs Angle
                    </div>
                    <div class="chart-area" id="heatmapChart"></div>
                </div>
            </div>
        </div>
        <!-- TAB 5: Events -->
        <div id="events" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    Important Events Over Time
                </div>
                <div class="chart-area" id="eventsChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    Events List
                </div>
                <div id="eventsList" style="height: 300px; overflow-y: auto;">
                    <div class="loading"><span class="spinner"></span>Loading events...</div>
                </div>
            </div>
        </div>
        <!-- TAB 6: Settings -->
        <div id="settings" class="tab-content">
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    Color Customization
                </div>
                <div class="theme-customizer" id="themeCustomizer"></div>
                <button class="btn" onclick="resetColors()" style="margin-top: 20px;">Reset to Default Colors</button>
            </div>
            <div class="chart-container">
                <div class="chart-title">
                    <div class="chart-icon"></div>
                    API Settings
                </div>
                <div style="padding: 20px; color: var(--text-secondary);">
                    <p>API URL: <strong>http://127.0.0.1:4567</strong></p>
                    <p>Status: <span id="apiConnectionStatus">Not connected</span></p>
                    <button class="btn" onclick="testConnection()" style="margin-top: 15px;">Test Connection</button>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <div class="footer">
            <p>© 2025 Autonomous Driving Dashboard | Live update with Flask</p>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="main.js"></script>
    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const API_URL = 'http://127.0.0.1:4567';
        const UPDATE_INTERVAL = 2000; // 2 seconds

        // ==========================================
        // DATA STORAGE
        // ==========================================
        let predictionData = {
            timestamps: [],
            steeringAngles: [],
            speeds: [],
            accelerations: [],
            events: []
        };

        let colors = {
            primary: '#6432c8',
            accent1: '#00ff88',
            accent2: '#ff6b9d',
            accent3: '#00d4ff',
            accent4: '#ff8c42'
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function log(msg) {
            console.log(`[Dashboard] ${msg}`);
        }

        function setCSS(varName, value) {
            document.documentElement.style.setProperty(varName, value);
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            log(`Switched to tab: ${tabName}`);
        }

        // ==========================================
        // API FUNCTIONS
        // ==========================================

        async function checkAPIConnection() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    updateAPIStatus(true);
                    log('API Connected ✓');
                    return true;
                }
            } catch (error) {
                updateAPIStatus(false);
                log(`API Error: ${error.message}`);
                return false;
            }
        }

        function updateAPIStatus(connected) {
            const indicator = document.getElementById('apiStatus');
            const text = document.getElementById('apiStatusText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Connected ✓';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Not Connected ✗';
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                if (!response.ok) throw new Error('Failed to fetch stats');
                
                const stats = await response.json();
                
                // Update statistics
                document.getElementById('totalPredictions').textContent = stats.total_predictions || 0;
                document.getElementById('avgAngle').textContent = (stats.avg_steering || 0).toFixed(2);
                document.getElementById('maxAngle').textContent = (stats.max_steering || 0).toFixed(2);
                
                // Calculate additional metrics
                updateCalculatedStats(stats);
                
            } catch (error) {
                log(`Stats fetch error: ${error.message}`);
            }
        }

        async function fetchHistory() {
            try {
                const response = await fetch(`${API_URL}/history`);
                if (!response.ok) throw new Error('Failed to fetch history');
                
                const data = await response.json();
                predictionData = processHistoryData(data.history || []);
                
                // Redraw all charts
                updateAllCharts();
                
            } catch (error) {
                log(`History fetch error: ${error.message}`);
            }
        }

        // ==========================================
        // DATA PROCESSING
        // ==========================================

        function processHistoryData(history) {
            const processed = {
                timestamps: [],
                steeringAngles: [],
                speeds: [],
                accelerations: [],
                events: []
            };

            history.forEach((item, index) => {
                processed.timestamps.push(item.timestamp || index);
                processed.steeringAngles.push(item.steering_angle || 0);
                processed.speeds.push(item.speed || 0);  // Use real speed from simulator
                
                // Calculate acceleration
                if (index > 0) {
                    processed.accelerations.push(processed.speeds[index] - processed.speeds[index - 1]);
                } else {
                    processed.accelerations.push(0);
                }
            });

            // Detect events
            processed.events = detectEvents(processed);

            return processed;
        }

        function detectEvents(data) {
            const events = [];
            const threshold = 15; // degrees

            data.steeringAngles.forEach((angle, idx) => {
                if (Math.abs(angle) > threshold) {
                    events.push({
                        timestamp: idx,
                        angle: angle,
                        type: angle > 0 ? 'يمين' : 'يسار',
                        severity: Math.abs(angle) > 25 ? 'حاد' : 'عادي'
                    });
                }
            });

            return events;
        }

        function updateCalculatedStats(stats) {
            // Turn count
            const turns = predictionData.events.length;
            document.getElementById('turnCount').textContent = turns;

            // Stability (std dev inverse)
            const stability = Math.max(0, 100 - (stats.std_steering || 0) * 10);
            document.getElementById('stability').textContent = stability.toFixed(0);
        }

        // ==========================================
        // CHART GENERATION
        // ==========================================

        function createSteeringChart() {
            const turnEvents = predictionData.events;

            // Create shapes for turned regions
            const shapes = [];
            turnEvents.forEach(event => {
                if (event.severity === 'حاد') {
                    shapes.push({
                        type: 'rect',
                        x0: event.timestamp - 0.5,
                        x1: event.timestamp + 0.5,
                        y0: -30,
                        y1: 30,
                        fillcolor: 'rgba(255, 107, 157, 0.1)',
                        line: { width: 0 }
                    });
                }
            });

            const trace = {
                x: predictionData.timestamps,
                y: predictionData.steeringAngles,
                mode: 'lines',
                name: 'زاوية التوجيه',
                line: { color: colors.accent3, width: 2 },
                hovertemplate: 'الإطار: %{x}<br>الزاوية: %{y:.2f}°<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'الإطار (Frame)' },
                yaxis: { title: 'الزاوية (درجة)' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                shapes: shapes,
                hovermode: 'x unified',
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('steeringChart', [trace], layout, { responsive: true });
        }

        function createSpeedChart() {
            const trace = {
                x: predictionData.timestamps,
                y: predictionData.speeds,
                mode: 'lines',
                name: 'السرعة',
                line: { color: colors.accent1, width: 2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(0, 255, 136, 0.1)',
                hovertemplate: 'الإطار: %{x}<br>السرعة: %{y:.2f} كم/س<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'الإطار (Frame)' },
                yaxis: { title: 'السرعة (كم/س)' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                hovermode: 'x unified',
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('speedChart', [trace], layout, { responsive: true });
        }

        function createAccelerationChart() {
            const trace = {
                x: predictionData.timestamps,
                y: predictionData.accelerations,
                mode: 'lines',
                name: 'التسارع',
                line: { color: colors.accent2, width: 2 },
                hovertemplate: 'الإطار: %{x}<br>التسارع: %{y:.3f}<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'الإطار (Frame)' },
                yaxis: { title: 'التسارع (مشتق السرعة)' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                hovermode: 'x unified',
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('accelerationChart', [trace], layout, { responsive: true });
        }

        function createHistogramChart() {
            const trace = {
                x: predictionData.steeringAngles,
                type: 'histogram',
                nbinsx: 30,
                name: 'التوزيع',
                marker: { color: colors.accent4 },
                hovertemplate: 'النطاق: %{x}<br>التكرار: %{y}<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'زاوية التوجيه (درجة)' },
                yaxis: { title: 'التكرار' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('histogramChart', [trace], layout, { responsive: true });
        }

        function createHeatmap() {
            // Create 2D histogram data
            const xBins = 10; // Speed bins
            const yBins = 10; // Angle bins

            const speedMin = Math.min(...predictionData.speeds);
            const speedMax = Math.max(...predictionData.speeds);
            const angleMin = Math.min(...predictionData.steeringAngles);
            const angleMax = Math.max(...predictionData.steeringAngles);

            const z = Array(yBins).fill(0).map(() => Array(xBins).fill(0));

            predictionData.speeds.forEach((speed, idx) => {
                const angle = predictionData.steeringAngles[idx];
                const xIdx = Math.floor(((speed - speedMin) / (speedMax - speedMin + 0.001)) * (xBins - 1));
                const yIdx = Math.floor(((angle - angleMin) / (angleMax - angleMin + 0.001)) * (yBins - 1));
                z[yIdx][xIdx]++;
            });

            const trace = {
                z: z,
                type: 'heatmap',
                colorscale: [
                    [0, '#1a1f3a'],
                    [0.5, colors.primary],
                    [1, colors.accent3]
                ],
                hovertemplate: 'السرعة: %{x}<br>الزاوية: %{y}<br>التكرار: %{z}<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'السرعة (كم/س)' },
                yaxis: { title: 'الزاوية (درجة)' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('heatmapChart', [trace], layout, { responsive: true });
        }

        function createEventsChart() {
            if (predictionData.events.length === 0) {
                document.getElementById('eventsChart').innerHTML = 
                    '<div class="loading">لا توجد أحداث حتى الآن</div>';
                return;
            }

            const trace = {
                x: predictionData.events.map(e => e.timestamp),
                y: predictionData.events.map(e => e.angle),
                mode: 'markers',
                type: 'scatter',
                name: 'الأحداث',
                marker: {
                    size: predictionData.events.map(e => e.severity === 'حاد' ? 12 : 8),
                    color: predictionData.events.map(e => e.severity === 'حاد' ? colors.accent2 : colors.accent1),
                    line: { width: 2, color: 'white' }
                },
                text: predictionData.events.map(e => `${e.type} - ${e.severity}`),
                hovertemplate: 'الإطار: %{x}<br>الزاوية: %{y:.2f}°<br>%{text}<extra></extra>'
            };

            const layout = {
                title: '',
                xaxis: { title: 'الإطار (Frame)' },
                yaxis: { title: 'الزاوية (درجة)' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                hovermode: 'closest',
                margin: { l: 60, r: 20, b: 50, t: 20 }
            };

            Plotly.newPlot('eventsChart', [trace], layout, { responsive: true });
        }

        function createOverviewChart() {
            const trace1 = {
                x: predictionData.timestamps,
                y: predictionData.steeringAngles,
                name: 'الزاوية',
                line: { color: colors.accent3 },
                yaxis: 'y1'
            };

            const trace2 = {
                x: predictionData.timestamps,
                y: predictionData.speeds,
                name: 'السرعة',
                line: { color: colors.accent1 },
                yaxis: 'y2'
            };

            const layout = {
                title: '',
                xaxis: { title: 'الإطار' },
                yaxis: { title: 'الزاوية (°)', titlefont: { color: colors.accent3 } },
                yaxis2: { title: 'السرعة (كم/س)', titlefont: { color: colors.accent1 }, overlaying: 'y', side: 'right' },
                plot_bgcolor: 'rgba(26, 31, 58, 0.5)',
                paper_bgcolor: 'transparent',
                font: { color: '#a8b2d1' },
                hovermode: 'x unified',
                margin: { l: 60, r: 60, b: 50, t: 20 }
            };

            Plotly.newPlot('overviewChart', [trace1, trace2], layout, { responsive: true });
        }

        function updateAllCharts() {
            try {
                createSteeringChart();
                createSpeedChart();
                createAccelerationChart();
                createHistogramChart();
                createHeatmap();
                createEventsChart();
                createOverviewChart();
                updateEventsList();
            } catch (error) {
                log(`Chart creation error: ${error.message}`);
            }
        }

        function updateEventsList() {
            const list = document.getElementById('eventsList');
            
            if (predictionData.events.length === 0) {
                list.innerHTML = '<div class="loading">لا توجد أحداث</div>';
                return;
            }

            list.innerHTML = predictionData.events.map((event, idx) => `
                <div style="padding: 15px; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong style="color: var(--text-primary);">الحدث #${idx + 1}</strong>
                        <span style="color: ${event.severity === 'حاد' ? colors.accent2 : colors.accent1};">
                            ${event.severity}
                        </span>
                    </div>
                    <div>الإطار: ${event.timestamp} | الزاوية: ${event.angle.toFixed(2)}° | الاتجاه: ${event.type}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // THEME CUSTOMIZATION
        // ==========================================

        function initializeColorCustomizer() {
            const customizer = document.getElementById('themeCustomizer');
            const colorFields = [
                { name: 'primary', label: 'اللون الأساسي' },
                { name: 'accent1', label: 'الأخضر' },
                { name: 'accent2', label: 'الوردي' },
                { name: 'accent3', label: 'السماوي' },
                { name: 'accent4', label: 'البرتقالي' }
            ];

            customizer.innerHTML = colorFields.map(field => `
                <div class="color-input-group">
                    <label class="color-label">${field.label}</label>
                    <input type="color" class="color-input" id="color-${field.name}" 
                        value="${colors[field.name]}" 
                        onchange="updateColor('${field.name}', this.value)">
                </div>
            `).join('');
        }

        function updateColor(colorName, value) {
            colors[colorName] = value;
            localStorage.setItem(`color-${colorName}`, value);
            updateAllCharts();
            log(`Color updated: ${colorName} = ${value}`);
        }

        function resetColors() {
            const defaultColors = {
                primary: '#6432c8',
                accent1: '#00ff88',
                accent2: '#ff6b9d',
                accent3: '#00d4ff',
                accent4: '#ff8c42'
            };

            Object.entries(defaultColors).forEach(([name, value]) => {
                colors[name] = value;
                document.getElementById(`color-${name}`).value = value;
                localStorage.removeItem(`color-${name}`);
            });

            updateAllCharts();
            log('Colors reset to default');
        }

        function loadSavedColors() {
            ['primary', 'accent1', 'accent2', 'accent3', 'accent4'].forEach(name => {
                const saved = localStorage.getItem(`color-${name}`);
                if (saved) {
                    colors[name] = saved;
                    const input = document.getElementById(`color-${name}`);
                    if (input) input.value = saved;
                }
            });
        }

        // ==========================================
        // CONNECTION TESTING
        // ==========================================

        async function testConnection() {
            const status = document.getElementById('apiConnectionStatus');
            status.textContent = 'Checking Connection ...';

            const connected = await checkAPIConnection();
            
            if (connected) {
                status.innerHTML = '✓ <span style="color: var(--success);">متصل بنجاح</span>';
                setTimeout(() => fetchHistory(), 500);
            } else {
                status.innerHTML = '✗ <span style="color: var(--danger);">فشل الاتصال - تأكد من تشغيل الخادم</span>';
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        async function initialize() {
            log('Initializing dashboard...');

            // Load saved colors
            loadSavedColors();
            initializeColorCustomizer();

            // Check API connection
            const connected = await checkAPIConnection();

            if (connected) {
                // Fetch initial data
                await Promise.all([fetchHistory(), fetchStats()]);

                // Set up automatic updates
                setInterval(async () => {
                    await Promise.all([fetchHistory(), fetchStats()]);
                }, UPDATE_INTERVAL);

                document.getElementById('apiConnectionStatus').innerHTML = 
                    '✓ <span style="color: var(--success);">متصل ومتزامن</span>';
            } else {
                document.getElementById('apiConnectionStatus').innerHTML = 
                    '✗ <span style="color: var(--danger);">فشل الاتصال بـ API</span>';
            }

            log('Dashboard ready!');
        }

        // Start when page loads
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>